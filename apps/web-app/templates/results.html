{% extends "base.html" %}

{% block title %}Bias Analysis Results - {{ results.dataset_info.filename }}{% endblock %}

{% block extra_head %}
<style>
/* Enhanced styling for clearer bias indicators */
.bias-verdict {
    text-align: center;
    padding: 2rem;
    border-radius: 15px;
    margin: 2rem 0;
    border: 3px solid;
    font-size: 1.2rem;
    font-weight: bold;
}

.bias-critical { 
    background: linear-gradient(135deg, #fee, #fcc);
    border-color: #dc3545;
    color: #721c24;
}

.bias-high { 
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-color: #fd7e14;
    color: #856404;
}

.bias-medium { 
    background: linear-gradient(135deg, #fff9e6, #ffeaa7);
    border-color: #ffc107;
    color: #664d03;
}

.bias-low { 
    background: linear-gradient(135deg, #e6f7ff, #b3e0ff);
    border-color: #17a2b8;
    color: #0c5460;
}

.bias-minimal { 
    background: linear-gradient(135deg, #d4edda, #a8e6cf);
    border-color: #28a745;
    color: #155724;
}

/* Chat interface styling */
.chat-container {
    height: 500px;
    border: 1px solid #ddd;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 10px;
    max-width: 80%;
}

.message.user {
    background: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.message.assistant {
    background: white;
    border: 1px solid #ddd;
    margin-right: auto;
}

.chat-input-area {
    padding: 1rem;
    border-top: 1px solid #ddd;
    background: white;
    border-radius: 0 0 10px 10px;
}

.suggestion-pills {
    margin: 0.5rem 0;
}

.suggestion-pill {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    margin: 0.25rem;
    background: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 15px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.suggestion-pill:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Enhanced metric cards */
.metric-card {
    text-align: center;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Progress bars for bias levels */
.bias-progress {
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    background: #e9ecef;
    margin: 1rem 0;
}

.bias-progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
}

.hover-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="fas fa-chart-line me-2 text-primary"></i>Bias Analysis Results
                    </h1>
                    <p class="text-muted mb-0">
                        Dataset: <strong>{{ results.dataset_info.filename }}</strong>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('download_report', session_id=session_id) }}" class="btn btn-danger">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Bias Verdict Section -->
    <div class="row mb-4">
        <div class="col">
            {% set risk = results.ai_analysis.risk_level %}
            {% set bias_score = results.ai_analysis.bias_score %}
            {% set violations_count = results.fairness_violations|length %}
            
            <div class="bias-verdict bias-{{ risk.lower() }}">
                {% if risk == 'CRITICAL' %}
                    üö® <strong>SEVERE BIAS DETECTED</strong> - IMMEDIATE ACTION REQUIRED
                    <div class="mt-2">Your system shows serious discrimination that could lead to legal issues.</div>
                {% elif risk == 'HIGH' %}
                    ‚ö†Ô∏è <strong>SIGNIFICANT BIAS FOUND</strong> - MITIGATION NEEDED
                    <div class="mt-2">Your system shows clear unfair treatment between different groups.</div>
                {% elif risk == 'MEDIUM' %}
                    ‚ö†Ô∏è <strong>MODERATE BIAS DETECTED</strong> - IMPROVEMENTS RECOMMENDED
                    <div class="mt-2">Your system shows some unfair patterns that should be addressed.</div>
                {% elif risk == 'LOW' %}
                    ‚úÖ <strong>MINOR BIAS FOUND</strong> - MONITORING SUGGESTED  
                    <div class="mt-2">Your system is mostly fair with minor issues to watch.</div>
                {% else %}
                    ‚úÖ <strong>MINIMAL BIAS</strong> - SYSTEM APPEARS FAIR
                    <div class="mt-2">Your system treats different groups fairly.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Enhanced Metrics Dashboard -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="metric-card {{ 'bg-danger' if risk == 'CRITICAL' else 'bg-warning' if risk == 'HIGH' else 'bg-info' if risk == 'MEDIUM' else 'bg-success' }} text-white">
                <div class="metric-value">{{ risk }}</div>
                <div class="metric-label text-white-50">Risk Level</div>
                <div class="bias-progress mt-3">
                    <div class="bias-progress-bar bg-white" style="width: {{ (bias_score * 100)|round }}%"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="metric-card bg-primary text-white">
                <div class="metric-value">{{ "%.3f"|format(bias_score) }}</div>
                <div class="metric-label text-white-50">Bias Score (0-1)</div>
                <small class="text-white-50">Higher = More Biased</small>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="metric-card {{ 'bg-danger' if violations_count > 2 else 'bg-warning' if violations_count > 0 else 'bg-success' }} text-white">
                <div class="metric-value">{{ violations_count }}</div>
                <div class="metric-label text-white-50">Fairness Violations</div>
                <small class="text-white-50">{{ "Critical Issues" if violations_count > 2 else "Issues Found" if violations_count > 0 else "No Issues" }}</small>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col text-center">
            <a href="{{ url_for('download_report', session_id=session_id) }}" class="btn btn-danger btn-lg me-3">
                <i class="fas fa-file-pdf me-2"></i>Download Detailed Report
            </a>
            <button class="btn btn-success btn-lg me-3" onclick="startChat()">
                <i class="fas fa-comments me-2"></i>Ask AI About Results
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Analyze New Dataset
            </a>
        </div>
    </div>

    <!-- Interactive Chat Interface -->
    <div class="row mb-4" id="chatSection" style="display: none;">
        <div class="col">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Chat with AI About Your Results
                        <button class="btn btn-sm btn-outline-light float-end" onclick="closeChat()">
                            <i class="fas fa-times"></i>
                        </button>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <!-- Chat messages will be inserted here -->
                        </div>
                        <div class="chat-input-area">
                            <div class="suggestion-pills" id="suggestions">
                                <!-- Suggestion pills will be inserted here -->
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" 
                                       placeholder="Ask me anything about your bias analysis..." 
                                       onkeypress="handleChatKeyPress(event)">
                                <button class="btn btn-success" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset Overview (Simplified) -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Dataset Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 text-primary">{{ "{:,}".format(results.summary.total_records) }}</div>
                            <small class="text-muted">Records</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-info">{{ results.summary.protected_attributes|length }}</div>
                            <small class="text-muted">Protected Attributes</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 text-success">1</div>
                            <small class="text-muted">Target Variable</small>
                        </div>
                    </div>
                    <hr>
                    <p><strong>Analyzing:</strong> {{ results.summary.target_variable }}</p>
                    <p><strong>For bias in:</strong> 
                        {% for attr in results.summary.protected_attributes %}
                            <span class="badge bg-secondary me-1">{{ attr }}</span>
                        {% endfor %}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Key Insights</h5>
                </div>
                <div class="card-body">
                    {% set ai_text = results.ai_analysis.ai_analysis %}
                    {% if ai_text %}
                        <p>{{ ai_text.split('.')[0] }}. {{ ai_text.split('.')[1] if ai_text.split('.')|length > 1 else '' }}</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <strong>Top Recommendation:</strong>
                        {% if results.ai_analysis.recommendations %}
                            <p class="text-success">{{ results.ai_analysis.recommendations[0] }}</p>
                        {% else %}
                            <p class="text-muted">See detailed report for recommendations</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis (Collapsible) -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#detailedAnalysis">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Detailed Bias Analysis
                            <i class="fas fa-chevron-down float-end"></i>
                        </h5>
                    </button>
                </div>
                <div class="collapse" id="detailedAnalysis">
                    <div class="card-body">
                        {% for attr, metrics in results.bias_metrics.items() %}
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2">{{ attr.upper() }} Analysis</h6>
                            
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Group</th>
                                            <th>Sample Size</th>
                                            <th>Positive Rate</th>
                                            <th>Representation</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group, stats in metrics.groups.items() %}
                                        <tr>
                                            <td><strong>{{ group }}</strong></td>
                                            <td>{{ "{:,}".format(stats.group_size) }}</td>
                                            <td>
                                                <span class="badge {{ 'bg-success' if stats.positive_rate > 0.6 else 'bg-warning' if stats.positive_rate > 0.4 else 'bg-danger' }}">
                                                    {{ "{:.1%}".format(stats.positive_rate) }}
                                                </span>
                                            </td>
                                            <td>{{ "{:.1%}".format(stats.representation) }}</td>
                                            <td>
                                                {% if stats.sample_adequacy == 'adequate' %}
                                                    <i class="fas fa-check-circle text-success" title="Good sample size"></i>
                                                {% else %}
                                                    <i class="fas fa-exclamation-triangle text-warning" title="Small sample"></i>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <h6>Statistical Parity</h6>
                                        <div class="h5 {{ 'text-danger' if metrics.disparities.statistical_parity_difference > 0.2 else 'text-warning' if metrics.disparities.statistical_parity_difference > 0.1 else 'text-success' }}">
                                            {{ "{:.1%}".format(metrics.disparities.statistical_parity_difference) }}
                                        </div>
                                        <small>Difference between groups (lower is better)</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <h6>80% Rule Test</h6>
                                        <div class="h5 {{ 'text-success' if metrics.fairness_metrics.passes_80_percent_rule else 'text-danger' }}">
                                            {{ "‚úÖ PASS" if metrics.fairness_metrics.passes_80_percent_rule else "‚ùå FAIL" }}
                                        </div>
                                        <small>{{ "Meets fairness threshold" if metrics.fairness_metrics.passes_80_percent_rule else "Fails fairness test" }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if not loop.last %}<hr>{% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Violations (if any) -->
    {% if results.fairness_violations %}
    <div class="row mb-4">
        <div class="col">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Critical Issues Found ({{ results.fairness_violations|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% for violation in results.fairness_violations %}
                    <div class="alert alert-{{ 'danger' if violation.severity == 'high' else 'warning' }} d-flex align-items-start">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-{{ 'exclamation-circle' if violation.severity == 'high' else 'exclamation-triangle' }} fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                {{ violation.type.replace('_', ' ').title() }}
                                <span class="badge bg-{{ 'danger' if violation.severity == 'high' else 'warning' }} ms-2">
                                    {{ violation.severity.upper() }}
                                </span>
                            </h6>
                            <p class="mb-1"><strong>Affects:</strong> {{ violation.attribute }}</p>
                            <p class="mb-0">{{ violation.description }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Chat JavaScript -->
<script>
let conversationId = null;
let isFirstMessage = true;

function startChat() {
    document.getElementById('chatSection').style.display = 'block';
    document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });
    
    if (isFirstMessage) {
        initializeChat();
        isFirstMessage = false;
    }
}

function closeChat() {
    document.getElementById('chatSection').style.display = 'none';
}

function initializeChat() {
    fetch('/start_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: '{{ session_id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.conversation_id) {
            conversationId = data.conversation_id;
            displayMessage(data.message, 'assistant');
            displaySuggestions(data.suggestions);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        displayMessage('Sorry, I encountered an error starting our conversation.', 'assistant');
    });
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || !conversationId) return;
    
    displayMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    displayTypingIndicator();
    
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            conversation_id: conversationId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        displayMessage(data.message, 'assistant');
        if (data.suggestions) {
            displaySuggestions(data.suggestions);
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Error:', error);
        displayMessage('Sorry, I encountered an error. Please try again.', 'assistant');
    });
}

function displayMessage(message, role) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = message.replace(/\n/g, '<br>');
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function displaySuggestions(suggestions) {
    const suggestionsDiv = document.getElementById('suggestions');
    suggestionsDiv.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const pill = document.createElement('span');
        pill.className = 'suggestion-pill';
        pill.textContent = suggestion;
        pill.onclick = () => {
            document.getElementById('chatInput').value = suggestion;
            sendMessage();
        };
        suggestionsDiv.appendChild(pill);
    });
}

function displayTypingIndicator() {
    const messagesDiv = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message assistant typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI is thinking...';
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Auto-focus chat input when chat opens
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('focus', function() {
            setTimeout(() => {
                this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        });
    }
});
</script>
{% endblock %}
